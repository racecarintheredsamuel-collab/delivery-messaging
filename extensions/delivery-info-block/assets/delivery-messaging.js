(function(){'use strict';if(window.DeliveryMessaging&&window.DeliveryMessaging._initialized){return}const CART_ENDPOINT='/cart.js';const CART_CHANGE_ENDPOINTS=['/cart/add','/cart/change','/cart/update','/cart/clear'];const DEFAULTS={threshold:5000,currency:'GBP',locale:'en-GB',messageProgress:'Spend {remaining} more for free delivery',messageUnlocked:"You've unlocked free delivery!",messageEmpty:'',messageExcluded:'',multiMatchMessage:'',excludeProperty:'_dm_exclude',exclusionRules:[],excludeTags:[],excludeHandles:[],debounceMs:300,pollIntervalMs:1000,pollWindowMs:5000,maxPollDurationMs:30000};const productTagsCache={};const debug=(...args)=>{if(window.__DIB_DEBUG__)console.log('[DM]',...args)};async function fetchProductTags(handle){if(!handle)return[];if(productTagsCache[handle])return productTagsCache[handle];try{const res=await fetch('/products/'+handle+'.json');if(!res.ok)return[];const data=await res.json();const tags=(data.product&&data.product.tags)?data.product.tags.split(', '):[];productTagsCache[handle]=tags;return tags}catch(e){return[]}}let config={...DEFAULTS};let cart=null;let cartSignature=null;let state={cartTotal:0,threshold:0,remaining:0,unlocked:false,excluded:false,excludedRule:null,multiMatch:false,isEmpty:true,messageText:'',lastUpdated:null};let fetchInFlight=false;let fetchQueued=false;let debounceTimer=null;let errorBackoffMs=1000;let consecutiveErrors=0;let pollTimer=null;let pollWindowTimer=null;let pollStartTime=null;let isPolling=false;const subscribers=new Set();const LOCALE_MAP={de:'de-DE',fr:'fr-FR',es:'es-ES',it:'it-IT',nl:'nl-NL',pt:'pt-PT',pl:'pl-PL',cs:'cs-CZ',da:'da-DK',fi:'fi-FI',sv:'sv-SE',nb:'nb-NO',el:'el-GR',hu:'hu-HU',ro:'ro-RO',sk:'sk-SK',sl:'sl-SI',bg:'bg-BG',hr:'hr-HR',lt:'lt-LT',lv:'lv-LV',et:'et-EE',en:'en-GB',ja:'ja-JP',ko:'ko-KR',zh:'zh-CN',ar:'ar-SA',he:'he-IL',th:'th-TH',vi:'vi-VN',tr:'tr-TR',ru:'ru-RU',uk:'uk-UA'};const EUR_LOCALE='de-DE';function formatMoney(amountMinor,currency,locale){try{let l=locale;if(currency==='EUR')l=EUR_LOCALE;else if(l&&l.length===2)l=LOCALE_MAP[l.toLowerCase()]||(l+'-'+l.toUpperCase());const amount=amountMinor/100;let formatted=new Intl.NumberFormat(l,{style:'currency',currency:currency,minimumFractionDigits:amount%1===0?0:2,maximumFractionDigits:2}).format(amount);if(currency==='EUR')formatted='€'+formatted.replace(/\s*€/,'');return formatted}catch(e){const symbol=currency==='GBP'?'£':currency==='USD'?'$':currency==='EUR'?'€':currency+' ';return symbol+(amountMinor/100).toFixed(2)}}function generateCartSignature(cartData){if(!cartData)return'';const itemSig=(cartData.items||[]).map(item=>`${item.key}:${item.quantity}`).join(',');return`${cartData.token||''}|${cartData.total_price}|${cartData.item_count}|${itemSig}`}async function checkExclusions(cartData){if(!cartData||!cartData.items)return{excluded:false,rule:null,multiMatch:false};for(const item of cartData.items){if(item.properties&&(item.properties[config.excludeProperty]===true||item.properties[config.excludeProperty]==='true')){return{excluded:true,rule:null,multiMatch:false}}}const matchedRules=new Set();if(config.exclusionRules&&config.exclusionRules.length>0){for(const rule of config.exclusionRules){const ruleTags=rule.tags||[];const ruleHandles=rule.handles||[];let ruleMatched=false;for(const item of cartData.items){const handle=item.handle;if(handle&&ruleHandles.length>0&&ruleHandles.includes(handle)){ruleMatched=true;break}if(handle&&ruleTags.length>0){const tags=await fetchProductTags(handle);if(ruleTags.some(t=>tags.includes(t))){ruleMatched=true;break}}}if(ruleMatched)matchedRules.add(rule)}}let legacyMatch=false;for(const item of cartData.items){const handle=item.handle;if(handle&&config.excludeHandles&&config.excludeHandles.length>0){if(config.excludeHandles.includes(handle)){legacyMatch=true;break}}if(handle&&config.excludeTags&&config.excludeTags.length>0){const tags=await fetchProductTags(handle);if(config.excludeTags.some(t=>tags.includes(t))){legacyMatch=true;break}}}const totalMatches=matchedRules.size+(legacyMatch?1:0);if(totalMatches>=2)return{excluded:true,rule:null,multiMatch:true};if(matchedRules.size===1)return{excluded:true,rule:[...matchedRules][0],multiMatch:false};if(legacyMatch)return{excluded:true,rule:null,multiMatch:false};return{excluded:false,rule:null,multiMatch:false}}function processTemplate(template,values){if(!template)return'';let result=template;for(const[key,value]of Object.entries(values)){result=result.replace(new RegExp(`\\{${key}\\}`,'g'),value)}return result}function normalizeUrl(url){if(/^(https?:\/\/|\/)/i.test(url))return url;if(url.includes('.')&&/^[a-z0-9][-a-z0-9]*\./i.test(url))return'https://'+url;return null}function parseMarkdown(text){if(!text)return text;let result=text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');if(result.includes('**')){result=result.split('**').map((part,i)=>i%2===1?'<strong>'+part+'</strong>':part).join('')}if(result.includes('[')){result=result.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(match,linkText,url)=>{const decodedUrl=url.replace(/&amp;/g,'&');const finalUrl=normalizeUrl(decodedUrl);if(!finalUrl)return match;return'<a href="'+finalUrl+'" target="_blank" rel="noopener" class="dib-link">'+linkText+'</a>'})}return result}function processLinks(html){if(!html||!html.includes('['))return html;return html.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(match,linkText,url)=>{const finalUrl=normalizeUrl(url);if(!finalUrl)return match;return'<a href="'+finalUrl+'" target="_blank" rel="noopener" class="dib-link">'+linkText+'</a>'})}function processMessageLinks(){document.querySelectorAll('.dib-msg-line').forEach(el=>{el.innerHTML=processLinks(el.innerHTML)});document.querySelectorAll('.dib-special-text').forEach(el=>{el.innerHTML=processLinks(el.innerHTML)})}function fetchCart(){if(fetchInFlight){fetchQueued=true;return}fetchInFlight=true;fetch(CART_ENDPOINT,{method:'GET',credentials:'same-origin',headers:{'Accept':'application/json'}}).then(response=>{if(!response.ok){throw new Error(`Cart fetch failed: ${response.status}`)}return response.json()}).then(cartData=>{consecutiveErrors=0;errorBackoffMs=1000;const newSignature=generateCartSignature(cartData);if(newSignature!==cartSignature){cartSignature=newSignature;cart=cartData;updateState()}}).catch(error=>{console.warn('[DeliveryMessaging] Cart fetch error:',error.message);consecutiveErrors++;if(consecutiveErrors>5){errorBackoffMs=Math.min(errorBackoffMs*2,30000)}}).finally(()=>{fetchInFlight=false;if(fetchQueued){fetchQueued=false;scheduleCartRefresh()}})}function scheduleCartRefresh(){if(debounceTimer){clearTimeout(debounceTimer)}debounceTimer=setTimeout(()=>{fetchCart()},config.debounceMs)}async function updateState(){const cartTotal=cart?cart.total_price:0;const isEmpty=!cart||cart.item_count===0;const exclusionResult=await checkExclusions(cart);const excluded=exclusionResult.excluded;const excludedRule=exclusionResult.rule;const multiMatch=exclusionResult.multiMatch;const threshold=config.threshold;const remaining=Math.max(0,threshold-cartTotal);const unlocked=threshold>0&&cartTotal>=threshold;const templateVars={remaining:formatMoney(remaining,config.currency,config.locale),threshold:formatMoney(threshold,config.currency,config.locale),total:formatMoney(cartTotal,config.currency,config.locale),cart_total:formatMoney(cartTotal,config.currency,config.locale)};let messageText='';if(excluded){let ruleMessage='';if(multiMatch){ruleMessage=config.multiMatchMessage||"Some items in your cart aren't eligible for free delivery"}else if(excludedRule&&excludedRule.cart_message){ruleMessage=excludedRule.cart_message}else{ruleMessage=config.messageExcluded}if(ruleMessage){messageText=processTemplate(ruleMessage,templateVars)}else{messageText=''}}else if(isEmpty){messageText=processTemplate(config.messageEmpty,templateVars)}else if(threshold===0){messageText=processTemplate(config.messageUnlocked,templateVars)}else if(unlocked){messageText=processTemplate(config.messageUnlocked,templateVars)}else{messageText=processTemplate(config.messageProgress,templateVars)}state={cartTotal,threshold,remaining,unlocked,excluded,excludedRule,multiMatch,isEmpty,messageText,lastUpdated:Date.now()};notifySubscribers();updateAllTargets()}function notifySubscribers(){const stateCopy={...state};subscribers.forEach(fn=>{try{fn(stateCopy)}catch(e){}})}function updateAllTargets(){const targets=document.querySelectorAll('[data-dm-target]');targets.forEach(target=>{if(target.hasAttribute('data-dm-cycling'))return;updateTarget(target)});updatePlaceholderSpans()}function updatePlaceholderSpans(){const remainingFormatted=formatMoney(state.remaining,config.currency,config.locale);const thresholdFormatted=formatMoney(state.threshold,config.currency,config.locale);const cartTotalFormatted=formatMoney(state.cartTotal,config.currency,config.locale);document.querySelectorAll('.dib-fd-remaining').forEach(el=>{el.textContent=remainingFormatted});document.querySelectorAll('.dib-fd-threshold').forEach(el=>{el.textContent=thresholdFormatted});document.querySelectorAll('.dib-fd-cart-total').forEach(el=>{el.textContent=cartTotalFormatted})}function updateTarget(target){const targetEmptyMessage=target.dataset.emptyMessage||'';const targetProgressMessage=target.dataset.progressMessage||'';const targetUnlockedMessage=target.dataset.unlockedMessage||'';const targetExcludedMessage=target.dataset.excludedMessage||'';const targetId=target.className||target.id||'unknown';debug('updateTarget',targetId,{progressMsg:targetProgressMessage,unlockedMsg:targetUnlockedMessage,emptyMsg:targetEmptyMessage,state:{unlocked:state.unlocked,isEmpty:state.isEmpty,excluded:state.excluded}});const noHide=target.hasAttribute('data-dm-no-hide');if(state.excluded){const excludedMsg=targetExcludedMessage||state.messageText;if(!excludedMsg&&!noHide){target.style.display='none';return}}const targetTemplateVars={remaining:formatMoney(state.remaining,config.currency,config.locale),threshold:formatMoney(state.threshold,config.currency,config.locale),total:formatMoney(state.cartTotal,config.currency,config.locale),cart_total:formatMoney(state.cartTotal,config.currency,config.locale)};if(state.isEmpty){if(targetEmptyMessage){if(!noHide)target.style.display='flex';const messageEl=target.querySelector('[data-dm-message]')||target;messageEl.innerHTML=parseMarkdown(processTemplate(targetEmptyMessage,targetTemplateVars));target.dataset.dmState='empty-message';debug('updateTarget',targetId,'using target empty message');return}else if(!state.messageText&&!noHide){target.style.display='none';return}}if(!noHide)target.style.display='flex';const messageEl=target.querySelector('[data-dm-message]')||target;let displayMessage=state.messageText;let messageSource='global';if(state.excluded&&targetExcludedMessage){displayMessage=processTemplate(targetExcludedMessage,targetTemplateVars);messageSource='target-excluded'}else if(state.unlocked&&targetUnlockedMessage){displayMessage=processTemplate(targetUnlockedMessage,targetTemplateVars);messageSource='target-unlocked'}else if(!state.unlocked&&!state.isEmpty&&targetProgressMessage){displayMessage=processTemplate(targetProgressMessage,targetTemplateVars);messageSource='target-progress'}debug('updateTarget',targetId,'chose',messageSource,displayMessage);const newHtml=parseMarkdown(displayMessage);const currentHtml=messageEl.innerHTML;const isSkeleton=currentHtml.includes('dib-fd-skeleton');if(currentHtml===newHtml){debug('updateTarget',targetId,'skipping - same content');messageEl.style.opacity='1'}else if(messageEl._dmPendingHtml===newHtml){debug('updateTarget',targetId,'skipping - fade in progress')}else if(isSkeleton){messageEl.innerHTML=newHtml;messageEl.style.opacity='1';debug('updateTarget',targetId,'direct set from skeleton')}else{if(window.__DIB_DRAWER_OPENING__){if(messageEl._dmAnimation){messageEl._dmAnimation.commitStyles();messageEl._dmAnimation.cancel();messageEl._dmAnimation=null}messageEl.innerHTML=newHtml;messageEl.style.opacity='1'}else{const willCelebrate=state.unlocked&&target.dataset.dmState==='progress'&&target.dataset.dmCelebrated==='';if(willCelebrate){if(messageEl._dmAnimation){messageEl._dmAnimation.cancel()}messageEl.style.opacity='0';messageEl.innerHTML=newHtml}else{if(messageEl._dmAnimation){messageEl._dmAnimation.commitStyles();messageEl._dmAnimation.cancel()}messageEl._dmPendingHtml=newHtml;messageEl._dmAnimation=messageEl.animate([{opacity:1},{opacity:0}],{duration:150,fill:'forwards'});messageEl._dmAnimation.finished.then(()=>{messageEl.style.opacity='0';messageEl.innerHTML=newHtml;requestAnimationFrame(()=>{messageEl._dmAnimation=messageEl.animate([{opacity:0},{opacity:1}],{duration:150,fill:'forwards'});messageEl._dmAnimation.finished.then(()=>{messageEl._dmPendingHtml=null;messageEl.style.opacity='1'}).catch(()=>{messageEl._dmPendingHtml=null;messageEl.style.opacity='1'})})}).catch(()=>{messageEl._dmPendingHtml=null})}}}const wasProgress=target.dataset.dmState==='progress';const newState=state.unlocked?'unlocked':(state.isEmpty?'empty':'progress');if(newState==='progress'){target.dataset.dmCelebrated=''}target.dataset.dmState=newState;target.dataset.dmExcluded=state.excluded?'true':'false';if(state.unlocked&&wasProgress&&target.dataset.dmCelebrated===''){target.dataset.dmCelebrated='done';target.classList.remove('dib-fd-celebrate');requestAnimationFrame(()=>{requestAnimationFrame(()=>{target.classList.add('dib-fd-celebrate');const msgEl=target.querySelector('[data-dm-message]')||target;target.addEventListener('animationend',function handler(){target.classList.remove('dib-fd-celebrate');msgEl.style.opacity='1';target.removeEventListener('animationend',handler)},{once:true})})})}const progressBar=target.querySelector('[data-dm-progress]');if(progressBar&&state.threshold>0){const percent=Math.min(100,(state.cartTotal/state.threshold)*100);const fg=state.excluded?'#9ca3af':(progressBar.dataset.fg||'#22c55e');const bg=progressBar.dataset.bg||'#e5e7eb';progressBar.style.background=`linear-gradient(to right, ${fg} ${percent}%, ${bg} ${percent}%)`}}function startPollingWindow(reason){if(isPolling)return;isPolling=true;pollStartTime=Date.now();if(pollTimer)clearInterval(pollTimer);if(pollWindowTimer)clearTimeout(pollWindowTimer);pollTimer=setInterval(()=>{if(Date.now()-pollStartTime>config.maxPollDurationMs){stopPolling();return}if(document.hidden)return;fetchCart()},config.pollIntervalMs);pollWindowTimer=setTimeout(()=>{stopPolling()},config.pollWindowMs)}function stopPolling(){isPolling=false;if(pollTimer){clearInterval(pollTimer);pollTimer=null}if(pollWindowTimer){clearTimeout(pollWindowTimer);pollWindowTimer=null}}function interceptFetch(){const originalFetch=window.fetch;window.fetch=function(input,init){const url=typeof input==='string'?input:(input.url||'');const isCartRequest=CART_CHANGE_ENDPOINTS.some(endpoint=>url.includes(endpoint));const promise=originalFetch.apply(this,arguments);if(isCartRequest){promise.then(()=>{scheduleCartRefresh();startPollingWindow('fetch')}).catch(()=>{scheduleCartRefresh()})}return promise}}function interceptXHR(){const originalOpen=XMLHttpRequest.prototype.open;const originalSend=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(method,url){this._dmUrl=url;return originalOpen.apply(this,arguments)};XMLHttpRequest.prototype.send=function(){const xhr=this;const url=xhr._dmUrl||'';const isCartRequest=CART_CHANGE_ENDPOINTS.some(endpoint=>url.includes(endpoint));if(isCartRequest){xhr.addEventListener('load',function(){scheduleCartRefresh();startPollingWindow('xhr')})}return originalSend.apply(this,arguments)}}function interceptFormSubmits(){document.addEventListener('submit',function(e){const form=e.target;if(!form||form.tagName!=='FORM')return;const action=form.action||'';if(action.includes('/cart/add')||action.includes('/cart')){setTimeout(()=>{scheduleCartRefresh();startPollingWindow('form')},500)}},true)}function interceptClicks(){document.addEventListener('click',function(e){const target=e.target;if(!target)return;const clickable=target.closest('button, a, [role="button"]');if(!clickable)return;const text=(clickable.textContent||'').toLowerCase();const classes=(clickable.className||'').toLowerCase();const name=(clickable.name||'').toLowerCase();const isCartButton=name.includes('add')||classes.includes('add-to-cart')||classes.includes('addtocart')||classes.includes('cart-add')||classes.includes('quantity')||classes.includes('qty-')||classes.includes('remove-from-cart')||classes.includes('cart-remove');if(isCartButton){setTimeout(()=>{scheduleCartRefresh();startPollingWindow('click')},800)}},true)}function handleVisibilityChange(){document.addEventListener('visibilitychange',function(){if(document.hidden){stopPolling()}else{scheduleCartRefresh()}})}function parseConfig(){let configEl=document.querySelector('[data-dm-config]');if(!configEl){configEl=document.querySelector('[data-dm-target]');if(!configEl){debug('parseConfig: no config element found');return}}const dataset=configEl.dataset;if(dataset.threshold){const parsed=parseInt(dataset.threshold,10);if(!isNaN(parsed)&&parsed>=0){config.threshold=parsed}}if(dataset.currency)config.currency=dataset.currency;if(dataset.locale)config.locale=dataset.locale;if(dataset.messageProgress)config.messageProgress=dataset.messageProgress;if(dataset.messageUnlocked)config.messageUnlocked=dataset.messageUnlocked;if(dataset.messageEmpty)config.messageEmpty=dataset.messageEmpty;if(dataset.messageExcluded)config.messageExcluded=dataset.messageExcluded;if(dataset.multiMatchMessage)config.multiMatchMessage=dataset.multiMatchMessage;if(dataset.excludeProperty)config.excludeProperty=dataset.excludeProperty;if(dataset.exclusionRules){try{config.exclusionRules=JSON.parse(dataset.exclusionRules)}catch(e){config.exclusionRules=[]}}if(dataset.excludeTags){try{config.excludeTags=JSON.parse(dataset.excludeTags)}catch(e){config.excludeTags=[]}}if(dataset.excludeHandles){try{config.excludeHandles=JSON.parse(dataset.excludeHandles)}catch(e){config.excludeHandles=[]}}if(dataset.debounceMs){const parsed=parseInt(dataset.debounceMs,10);if(!isNaN(parsed)&&parsed>0)config.debounceMs=parsed}debug('parseConfig: global config',{threshold:config.threshold,messageProgress:config.messageProgress,messageUnlocked:config.messageUnlocked})}window.DeliveryMessaging={_initialized:true,getCart:function(){return cart?{...cart}:null},getState:function(){return{...state}},getConfig:function(){return{...config}},refresh:function(){scheduleCartRefresh()},subscribe:function(fn){if(typeof fn==='function'){subscribers.add(fn);try{fn({...state})}catch(e){}return function(){subscribers.delete(fn)}}return function(){}},formatMoney:function(amountMinor){return formatMoney(amountMinor,config.currency,config.locale)},setConfig:function(newConfig){Object.assign(config,newConfig);updateState()},forceUpdate:function(){updateAllTargets()}};function init(){parseConfig();interceptFetch();interceptXHR();interceptFormSubmits();interceptClicks();handleVisibilityChange();fetchCart();processMessageLinks()}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',init)}else{init()}})();

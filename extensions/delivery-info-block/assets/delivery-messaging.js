(function(){'use strict';if(window.DeliveryMessaging&&window.DeliveryMessaging._initialized){return}const CART_ENDPOINT='/cart.js';const CART_CHANGE_ENDPOINTS=['/cart/add','/cart/change','/cart/update','/cart/clear'];const DEFAULTS={threshold:5000,currency:'GBP',locale:'en-GB',messageProgress:'Spend {remaining} more for free delivery',messageUnlocked:"You've unlocked free delivery!",messageEmpty:'',messageExcluded:'',excludeProperty:'_dm_exclude',excludeTags:[],excludeHandles:[],debounceMs:300,pollIntervalMs:1000,pollWindowMs:5000,maxPollDurationMs:30000};const productTagsCache={};async function fetchProductTags(handle){if(!handle)return[];if(productTagsCache[handle])return productTagsCache[handle];try{const res=await fetch('/products/'+handle+'.json');if(!res.ok)return[];const data=await res.json();const tags=(data.product&&data.product.tags)?data.product.tags.split(', '):[];productTagsCache[handle]=tags;return tags}catch(e){return[]}}let config={...DEFAULTS};let cart=null;let cartSignature=null;let state={cartTotal:0,threshold:0,remaining:0,unlocked:false,excluded:false,isEmpty:true,messageText:'',lastUpdated:null};let fetchInFlight=false;let fetchQueued=false;let debounceTimer=null;let errorBackoffMs=1000;let consecutiveErrors=0;let pollTimer=null;let pollWindowTimer=null;let pollStartTime=null;let isPolling=false;const subscribers=new Set();function formatMoney(amountMinor,currency,locale){try{const amount=amountMinor/100;return new Intl.NumberFormat(locale,{style:'currency',currency:currency,minimumFractionDigits:amount%1===0?0:2,maximumFractionDigits:2}).format(amount)}catch(e){const symbol=currency==='GBP'?'£':currency==='USD'?'$':currency==='EUR'?'€':currency+' ';return symbol+(amountMinor/100).toFixed(2)}}function generateCartSignature(cartData){if(!cartData)return'';const itemSig=(cartData.items||[]).map(item=>`${item.key}:${item.quantity}`).join(',');return`${cartData.token||''}|${cartData.total_price}|${cartData.item_count}|${itemSig}`}async function checkExclusions(cartData){if(!cartData||!cartData.items)return false;for(const item of cartData.items){if(item.properties&&(item.properties[config.excludeProperty]===true||item.properties[config.excludeProperty]==='true')){return true}const handle=item.handle;if(handle&&config.excludeHandles&&config.excludeHandles.length>0){if(config.excludeHandles.includes(handle))return true}if(handle&&config.excludeTags&&config.excludeTags.length>0){const tags=await fetchProductTags(handle);if(config.excludeTags.some(t=>tags.includes(t)))return true}}return false}function processTemplate(template,values){if(!template)return'';let result=template;for(const[key,value]of Object.entries(values)){result=result.replace(new RegExp(`\\{${key}\\}`,'g'),value)}return result}function parseMarkdownBold(text){if(!text||!text.includes('**'))return text;const escaped=text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');return escaped.split('**').map((part,i)=>i%2===1?'<strong>'+part+'</strong>':part).join('')}function fetchCart(){if(fetchInFlight){fetchQueued=true;return}fetchInFlight=true;fetch(CART_ENDPOINT,{method:'GET',credentials:'same-origin',headers:{'Accept':'application/json'}}).then(response=>{if(!response.ok){throw new Error(`Cart fetch failed: ${response.status}`)}return response.json()}).then(cartData=>{consecutiveErrors=0;errorBackoffMs=1000;const newSignature=generateCartSignature(cartData);if(newSignature!==cartSignature){cartSignature=newSignature;cart=cartData;updateState()}}).catch(error=>{console.warn('[DeliveryMessaging] Cart fetch error:',error.message);consecutiveErrors++;if(consecutiveErrors>5){errorBackoffMs=Math.min(errorBackoffMs*2,30000)}}).finally(()=>{fetchInFlight=false;if(fetchQueued){fetchQueued=false;scheduleCartRefresh()}})}function scheduleCartRefresh(){if(debounceTimer){clearTimeout(debounceTimer)}debounceTimer=setTimeout(()=>{fetchCart()},config.debounceMs)}async function updateState(){const cartTotal=cart?cart.total_price:0;const isEmpty=!cart||cart.item_count===0;const excluded=await checkExclusions(cart);const threshold=config.threshold;const remaining=Math.max(0,threshold-cartTotal);const unlocked=threshold>0&&cartTotal>=threshold;const templateVars={remaining:formatMoney(remaining,config.currency,config.locale),threshold:formatMoney(threshold,config.currency,config.locale),total:formatMoney(cartTotal,config.currency,config.locale),cart_total:formatMoney(cartTotal,config.currency,config.locale)};let messageText='';if(excluded&&config.messageExcluded){messageText=processTemplate(config.messageExcluded,templateVars)}else if(excluded){messageText=''}else if(isEmpty){messageText=processTemplate(config.messageEmpty,templateVars)}else if(threshold===0){messageText=processTemplate(config.messageUnlocked,templateVars)}else if(unlocked){messageText=processTemplate(config.messageUnlocked,templateVars)}else{messageText=processTemplate(config.messageProgress,templateVars)}state={cartTotal,threshold,remaining,unlocked,excluded,isEmpty,messageText,lastUpdated:Date.now()};notifySubscribers();updateAllTargets()}function notifySubscribers(){const stateCopy={...state};subscribers.forEach(fn=>{try{fn(stateCopy)}catch(e){}})}function updateAllTargets(){const targets=document.querySelectorAll('[data-dm-target]');targets.forEach(target=>{updateTarget(target)});updatePlaceholderSpans()}function updatePlaceholderSpans(){const remainingFormatted=formatMoney(state.remaining,config.currency,config.locale);const thresholdFormatted=formatMoney(state.threshold,config.currency,config.locale);const cartTotalFormatted=formatMoney(state.cartTotal,config.currency,config.locale);document.querySelectorAll('.dib-fd-remaining').forEach(el=>{el.textContent=remainingFormatted});document.querySelectorAll('.dib-fd-threshold').forEach(el=>{el.textContent=thresholdFormatted});document.querySelectorAll('.dib-fd-cart-total').forEach(el=>{el.textContent=cartTotalFormatted})}function updateTarget(target){const targetEmptyMessage=target.dataset.emptyMessage||'';const targetProgressMessage=target.dataset.progressMessage||'';const targetUnlockedMessage=target.dataset.unlockedMessage||'';const targetExcludedMessage=target.dataset.excludedMessage||'';if(state.excluded){const excludedMsg=targetExcludedMessage||state.messageText;if(!excludedMsg){target.style.display='none';return}}const targetTemplateVars={remaining:formatMoney(state.remaining,config.currency,config.locale),threshold:formatMoney(state.threshold,config.currency,config.locale),total:formatMoney(state.cartTotal,config.currency,config.locale),cart_total:formatMoney(state.cartTotal,config.currency,config.locale)};if(state.isEmpty){if(targetEmptyMessage){target.style.display='flex';const messageEl=target.querySelector('[data-dm-message]')||target;messageEl.innerHTML=parseMarkdownBold(processTemplate(targetEmptyMessage,targetTemplateVars));target.dataset.dmState='empty-message';return}else if(!state.messageText){target.style.display='none';return}}target.style.display='flex';const messageEl=target.querySelector('[data-dm-message]')||target;let displayMessage=state.messageText;if(state.excluded&&targetExcludedMessage){displayMessage=processTemplate(targetExcludedMessage,targetTemplateVars)}else if(state.unlocked&&targetUnlockedMessage){displayMessage=processTemplate(targetUnlockedMessage,targetTemplateVars)}else if(!state.unlocked&&!state.isEmpty&&targetProgressMessage){displayMessage=processTemplate(targetProgressMessage,targetTemplateVars)}messageEl.innerHTML=parseMarkdownBold(displayMessage);const wasProgress=target.dataset.dmState==='progress';const newState=state.unlocked?'unlocked':(state.isEmpty?'empty':'progress');if(newState==='progress'){target.dataset.dmCelebrated=''}target.dataset.dmState=newState;target.dataset.dmExcluded=state.excluded?'true':'false';if(state.unlocked&&wasProgress&&target.dataset.dmCelebrated===''){target.dataset.dmCelebrated='done';target.classList.add('dib-fd-celebrate');target.addEventListener('animationend',function handler(){target.classList.remove('dib-fd-celebrate');target.removeEventListener('animationend',handler)},{once:true})}const progressBar=target.querySelector('[data-dm-progress]');if(progressBar&&state.threshold>0){const percent=Math.min(100,(state.cartTotal/state.threshold)*100);const fg=progressBar.dataset.fg||'#22c55e';const bg=progressBar.dataset.bg||'#e5e7eb';progressBar.style.background=`linear-gradient(to right, ${fg} ${percent}%, ${bg} ${percent}%)`}}function startPollingWindow(reason){if(isPolling)return;isPolling=true;pollStartTime=Date.now();if(pollTimer)clearInterval(pollTimer);if(pollWindowTimer)clearTimeout(pollWindowTimer);pollTimer=setInterval(()=>{if(Date.now()-pollStartTime>config.maxPollDurationMs){stopPolling();return}if(document.hidden)return;fetchCart()},config.pollIntervalMs);pollWindowTimer=setTimeout(()=>{stopPolling()},config.pollWindowMs)}function stopPolling(){isPolling=false;if(pollTimer){clearInterval(pollTimer);pollTimer=null}if(pollWindowTimer){clearTimeout(pollWindowTimer);pollWindowTimer=null}}function interceptFetch(){const originalFetch=window.fetch;window.fetch=function(input,init){const url=typeof input==='string'?input:(input.url||'');const isCartRequest=CART_CHANGE_ENDPOINTS.some(endpoint=>url.includes(endpoint));const promise=originalFetch.apply(this,arguments);if(isCartRequest){promise.then(()=>{scheduleCartRefresh();startPollingWindow('fetch')}).catch(()=>{scheduleCartRefresh()})}return promise}}function interceptXHR(){const originalOpen=XMLHttpRequest.prototype.open;const originalSend=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(method,url){this._dmUrl=url;return originalOpen.apply(this,arguments)};XMLHttpRequest.prototype.send=function(){const xhr=this;const url=xhr._dmUrl||'';const isCartRequest=CART_CHANGE_ENDPOINTS.some(endpoint=>url.includes(endpoint));if(isCartRequest){xhr.addEventListener('load',function(){scheduleCartRefresh();startPollingWindow('xhr')})}return originalSend.apply(this,arguments)}}function interceptFormSubmits(){document.addEventListener('submit',function(e){const form=e.target;if(!form||form.tagName!=='FORM')return;const action=form.action||'';if(action.includes('/cart/add')||action.includes('/cart')){setTimeout(()=>{scheduleCartRefresh();startPollingWindow('form')},500)}},true)}function interceptClicks(){document.addEventListener('click',function(e){const target=e.target;if(!target)return;const clickable=target.closest('button, a, [role="button"]');if(!clickable)return;const text=(clickable.textContent||'').toLowerCase();const classes=(clickable.className||'').toLowerCase();const name=(clickable.name||'').toLowerCase();const isCartButton=name.includes('add')||classes.includes('add-to-cart')||classes.includes('addtocart')||classes.includes('cart-add')||classes.includes('quantity')||classes.includes('qty-')||classes.includes('remove-from-cart')||classes.includes('cart-remove');if(isCartButton){setTimeout(()=>{scheduleCartRefresh();startPollingWindow('click')},800)}},true)}function handleVisibilityChange(){document.addEventListener('visibilitychange',function(){if(document.hidden){stopPolling()}else{scheduleCartRefresh()}})}function parseConfig(){const configEl=document.querySelector('[data-dm-config]');if(!configEl){return}const dataset=configEl.dataset;if(dataset.threshold){const parsed=parseInt(dataset.threshold,10);if(!isNaN(parsed)&&parsed>=0){config.threshold=parsed}}if(dataset.currency)config.currency=dataset.currency;if(dataset.locale)config.locale=dataset.locale;if(dataset.messageProgress)config.messageProgress=dataset.messageProgress;if(dataset.messageUnlocked)config.messageUnlocked=dataset.messageUnlocked;if(dataset.messageEmpty)config.messageEmpty=dataset.messageEmpty;if(dataset.messageExcluded)config.messageExcluded=dataset.messageExcluded;if(dataset.excludeProperty)config.excludeProperty=dataset.excludeProperty;if(dataset.excludeTags){try{config.excludeTags=JSON.parse(dataset.excludeTags)}catch(e){config.excludeTags=[]}}if(dataset.excludeHandles){try{config.excludeHandles=JSON.parse(dataset.excludeHandles)}catch(e){config.excludeHandles=[]}}if(dataset.debounceMs){const parsed=parseInt(dataset.debounceMs,10);if(!isNaN(parsed)&&parsed>0)config.debounceMs=parsed}}window.DeliveryMessaging={_initialized:true,getCart:function(){return cart?{...cart}:null},getState:function(){return{...state}},getConfig:function(){return{...config}},refresh:function(){scheduleCartRefresh()},subscribe:function(fn){if(typeof fn==='function'){subscribers.add(fn);try{fn({...state})}catch(e){}return function(){subscribers.delete(fn)}}return function(){}},formatMoney:function(amountMinor){return formatMoney(amountMinor,config.currency,config.locale)},setConfig:function(newConfig){Object.assign(config,newConfig);updateState()},forceUpdate:function(){updateAllTargets()}};function init(){parseConfig();interceptFetch();interceptXHR();interceptFormSubmits();interceptClicks();handleVisibilityChange();fetchCart()}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',init)}else{init()}})();

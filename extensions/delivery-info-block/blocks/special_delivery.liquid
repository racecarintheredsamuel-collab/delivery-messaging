{%- assign uid = 'special-' | append: block.id -%}
{%- assign show_special_delivery_final = false -%}
{%- assign special_delivery_message_final = '' -%}
{%- assign special_delivery_icon_final = '' -%}
{%- assign special_delivery_icon_style_final = 'solid' -%}
{%- assign special_delivery_icon_size_final = 24 -%}
{%- assign special_delivery_icon_alignment_final = 'top' -%}
{%- assign special_delivery_icon_color_final = '#111827' -%}
{%- assign special_delivery_use_main_icon_color_final = true -%}
{%- assign icon_color = '#111827' -%}

{%- assign special_delivery_use_theme_font_final = true -%}
{%- assign special_delivery_match_messages_font_final = false -%}
{%- assign special_delivery_custom_font_family_final = '' -%}
{%- assign special_delivery_use_theme_text_styling_final = true -%}
{%- assign special_delivery_text_color_final = '#374151' -%}
{%- assign special_delivery_font_size_final = 'medium' -%}
{%- assign special_delivery_font_weight_final = 'normal' -%}

{%- assign messages_custom_font_family = '' -%}

{%- assign special_delivery_margin_top = 0 -%}
{%- assign special_delivery_margin_bottom = 0 -%}
{%- assign special_delivery_alignment = 'left' -%}
{%- assign special_delivery_text_alignment_final = 'left' -%}

{%- assign special_delivery_padding_horizontal = 12 -%}
{%- assign special_delivery_padding_vertical = 10 -%}
{%- assign special_delivery_icon_gap = 12 -%}

{%- assign special_delivery_show_border_final = false -%}
{%- assign special_delivery_border_thickness_final = 1 -%}
{%- assign special_delivery_border_color_final = '#e5e7eb' -%}
{%- assign special_delivery_border_radius_final = 8 -%}
{%- assign special_delivery_match_eta_border_final = false -%}
{%- assign special_delivery_match_eta_width_final = false -%}
{%- assign special_delivery_max_width_final = 600 -%}

{%- assign eta_border_width = 1 -%}
{%- assign eta_border_color = '#e5e7eb' -%}
{%- assign eta_border_radius = 8 -%}
{%- assign show_eta_timeline = false -%}
{%- assign show_eta_border = false -%}
{%- assign rules_json = shop.metafields.delivery_rules.config.value -%}
{%- assign rules_obj = nil -%}
{%- assign rules = nil -%}
{%- if rules_json != blank -%}
  {%- assign rules_obj = rules_json | parse_json -%}
  {%- if rules_obj.version == 2 -%}
    {%- assign active_profile_id = rules_obj.activeProfileId | strip -%}
    {%- assign found_profile = false -%}
    {%- for profile in rules_obj.profiles -%}
      {%- assign profile_id_check = profile.id | strip -%}
      {%- if profile_id_check == active_profile_id -%}
        {%- assign rules = profile.rules -%}
        {%- assign found_profile = true -%}
        {%- break -%}
      {%- endif -%}
    {%- endfor -%}
    {%- if found_profile == false and rules_obj.profiles.size > 0 -%}
      {%- assign rules = rules_obj.profiles.first.rules -%}
    {%- endif -%}
  {%- else -%}
    {%- assign rules = rules_obj.rules -%}
  {%- endif -%}
{%- endif -%}
{%- assign global_settings_json = shop.metafields.delivery_rules.settings.value -%}
{%- assign global_settings = nil -%}
{%- if global_settings_json != blank -%}
  {%- assign global_settings = global_settings_json | parse_json -%}
{%- endif -%}
{%- if global_settings != nil -%}
  
  {%- if global_settings.special_delivery_use_theme_font == false -%}{%- assign special_delivery_use_theme_font_final = false -%}{%- endif -%}
  {%- if global_settings.special_delivery_match_messages_font == true -%}{%- assign special_delivery_match_messages_font_final = true -%}{%- endif -%}
  {%- if global_settings.special_delivery_custom_font_family != blank -%}{%- assign special_delivery_custom_font_family_final = global_settings.special_delivery_custom_font_family -%}{%- endif -%}
  {%- if global_settings.special_delivery_use_theme_text_styling == false -%}{%- assign special_delivery_use_theme_text_styling_final = false -%}{%- endif -%}
  {%- if global_settings.special_delivery_text_color != blank -%}{%- assign special_delivery_text_color_final = global_settings.special_delivery_text_color -%}{%- endif -%}
  {%- if global_settings.special_delivery_font_size != blank -%}{%- assign special_delivery_font_size_final = global_settings.special_delivery_font_size -%}{%- endif -%}
  {%- if global_settings.special_delivery_font_weight != blank -%}{%- assign special_delivery_font_weight_final = global_settings.special_delivery_font_weight -%}{%- endif -%}
  
  {%- if global_settings.custom_font_family != blank -%}{%- assign messages_custom_font_family = global_settings.custom_font_family -%}{%- endif -%}
  
  {%- if global_settings.special_delivery_margin_top != blank -%}{%- assign special_delivery_margin_top = global_settings.special_delivery_margin_top -%}{%- endif -%}
  {%- if global_settings.special_delivery_margin_bottom != blank -%}{%- assign special_delivery_margin_bottom = global_settings.special_delivery_margin_bottom -%}{%- endif -%}
  {%- if global_settings.special_delivery_alignment != blank -%}{%- assign special_delivery_alignment = global_settings.special_delivery_alignment -%}{%- endif -%}
  {%- if global_settings.special_delivery_padding_horizontal != blank -%}{%- assign special_delivery_padding_horizontal = global_settings.special_delivery_padding_horizontal -%}{%- endif -%}
  {%- if global_settings.special_delivery_padding_vertical != blank -%}{%- assign special_delivery_padding_vertical = global_settings.special_delivery_padding_vertical -%}{%- endif -%}
  {%- if global_settings.special_delivery_icon_gap != blank -%}{%- assign special_delivery_icon_gap = global_settings.special_delivery_icon_gap -%}{%- endif -%}
{%- endif -%}
{%- assign any_rule_matched = false -%}
{%- if product and rules and rules.size > 0 -%}
  {%- assign product_handle = product.handle -%}
  {%- for r in rules -%}
    {%- assign m = r.match -%}
    {%- assign handle_match = false -%}
    {%- assign tag_match = false -%}
    {%- if m.product_handles and m.product_handles.size > 0 and m.product_handles contains product_handle -%}
      {%- assign handle_match = true -%}
    {%- endif -%}
    {%- if m.tags and m.tags.size > 0 -%}
      {%- for tg in m.tags -%}
        {%- if product.tags contains tg -%}
          {%- assign tag_match = true -%}
          {% break %}
        {%- endif -%}
      {%- endfor -%}
    {%- endif -%}
    {%- assign stock_match = true -%}
    {%- assign stock_status_value = m.stock_status | default: 'any' -%}
    {%- if stock_status_value != 'any' -%}
      {%- assign has_stock = false -%}
      {%- assign is_pre_order = false -%}
      {%- assign is_mixed_stock = false -%}
      {%- assign has_in_stock_variant = false -%}
      {%- assign has_out_of_stock_variant = false -%}
      {%- assign has_preorder_variant = false -%}
      {%- for variant in product.variants -%}
        {%- if variant.available and variant.inventory_quantity > 0 -%}
          {%- assign has_in_stock_variant = true -%}
        {%- elsif variant.available and variant.inventory_quantity <= 0 -%}
          {%- assign has_preorder_variant = true -%}
        {%- elsif variant.available == false -%}
          {%- assign has_out_of_stock_variant = true -%}
        {%- endif -%}
      {%- endfor -%}
      {%- assign status_count = 0 -%}
      {%- if has_in_stock_variant -%}{%- assign status_count = status_count | plus: 1 -%}{%- endif -%}
      {%- if has_out_of_stock_variant -%}{%- assign status_count = status_count | plus: 1 -%}{%- endif -%}
      {%- if has_preorder_variant -%}{%- assign status_count = status_count | plus: 1 -%}{%- endif -%}
      {%- if status_count > 1 -%}{%- assign is_mixed_stock = true -%}{%- endif -%}
      {%- if product.available -%}
        {%- assign has_stock = true -%}
        {%- if has_in_stock_variant == false and has_preorder_variant -%}{%- assign is_pre_order = true -%}{%- endif -%}
      {%- endif -%}
      {%- if stock_status_value == 'in_stock' and has_stock == false -%}{%- assign stock_match = false -%}{%- endif -%}
      {%- if stock_status_value == 'in_stock' and is_pre_order == true -%}{%- assign stock_match = false -%}{%- endif -%}
      {%- if stock_status_value == 'in_stock' and is_mixed_stock == true -%}{%- assign stock_match = false -%}{%- endif -%}
      {%- if stock_status_value == 'out_of_stock' and has_stock == true -%}{%- assign stock_match = false -%}{%- endif -%}
      {%- if stock_status_value == 'pre_order' and is_pre_order == false -%}{%- assign stock_match = false -%}{%- endif -%}
      {%- if stock_status_value == 'pre_order' and is_mixed_stock == true -%}{%- assign stock_match = false -%}{%- endif -%}
      {%- if stock_status_value == 'mixed_stock' and is_mixed_stock == false -%}{%- assign stock_match = false -%}{%- endif -%}
    {%- endif -%}
    {%- assign final_match = false -%}
    {%- if m.is_fallback == true or m.is_fallback == 'true' -%}
      {%- if stock_match -%}{%- assign final_match = true -%}{%- endif -%}
    {%- elsif handle_match or tag_match -%}
      {%- if stock_match -%}{%- assign final_match = true -%}{%- endif -%}
    {%- endif -%}
    {%- if final_match -%}
      {%- assign any_rule_matched = true -%}
      {%- assign s = r.settings -%}
      {%- if s.icon_color != blank -%}{%- assign icon_color = s.icon_color -%}{%- endif -%}
      
      {%- if s.show_eta_timeline == true or s.show_eta_timeline == 'true' -%}{%- assign show_eta_timeline = true -%}{%- endif -%}
      {%- if s.show_eta_border == true or s.show_eta_border == 'true' -%}{%- assign show_eta_border = true -%}{%- endif -%}
      {%- if s.eta_border_width != blank -%}{%- assign eta_border_width = s.eta_border_width -%}{%- endif -%}
      {%- if s.eta_border_color != blank -%}{%- assign eta_border_color = s.eta_border_color -%}{%- endif -%}
      {%- if s.eta_border_radius != blank -%}{%- assign eta_border_radius = s.eta_border_radius -%}{%- endif -%}
      
      {%- if s.show_special_delivery == true or s.show_special_delivery == 'true' -%}{%- assign show_special_delivery_final = true -%}{%- endif -%}
      {%- if s.show_special_delivery == false or s.show_special_delivery == 'false' -%}{%- assign show_special_delivery_final = false -%}{%- endif -%}
      {%- if s.special_delivery_message != blank -%}{%- assign special_delivery_message_final = s.special_delivery_message -%}{%- endif -%}
      {%- if s.special_delivery_icon != blank -%}{%- assign special_delivery_icon_final = s.special_delivery_icon -%}{%- endif -%}
      {%- if s.special_delivery_icon_style != blank -%}{%- assign special_delivery_icon_style_final = s.special_delivery_icon_style -%}{%- endif -%}
      {%- if s.special_delivery_icon_size != blank -%}{%- assign special_delivery_icon_size_final = s.special_delivery_icon_size -%}{%- endif -%}
      {%- if s.special_delivery_icon_alignment != blank -%}{%- assign special_delivery_icon_alignment_final = s.special_delivery_icon_alignment -%}{%- endif -%}
      {%- if s.special_delivery_icon_color != blank -%}{%- assign special_delivery_icon_color_final = s.special_delivery_icon_color -%}{%- endif -%}
      {%- if s.special_delivery_use_main_icon_color == true or s.special_delivery_use_main_icon_color == 'true' -%}{%- assign special_delivery_use_main_icon_color_final = true -%}{%- endif -%}
      {%- if s.special_delivery_use_main_icon_color == false or s.special_delivery_use_main_icon_color == 'false' -%}{%- assign special_delivery_use_main_icon_color_final = false -%}{%- endif -%}
      
      {%- if s.special_delivery_show_border == true or s.special_delivery_show_border == 'true' -%}{%- assign special_delivery_show_border_final = true -%}{%- endif -%}
      {%- if s.special_delivery_border_thickness != blank -%}{%- assign special_delivery_border_thickness_final = s.special_delivery_border_thickness -%}{%- endif -%}
      {%- if s.special_delivery_border_color != blank -%}{%- assign special_delivery_border_color_final = s.special_delivery_border_color -%}{%- endif -%}
      {%- if s.special_delivery_border_radius != blank -%}{%- assign special_delivery_border_radius_final = s.special_delivery_border_radius -%}{%- endif -%}
      {%- if s.special_delivery_match_eta_border == true or s.special_delivery_match_eta_border == 'true' -%}
        {%- assign special_delivery_match_eta_border_final = true -%}
        {%- assign special_delivery_show_border_final = true -%}
        {%- assign special_delivery_border_thickness_final = eta_border_width -%}
        {%- assign special_delivery_border_color_final = eta_border_color -%}
        {%- assign special_delivery_border_radius_final = eta_border_radius -%}
      {%- endif -%}
      {%- if s.special_delivery_match_eta_width == true or s.special_delivery_match_eta_width == 'true' -%}{%- assign special_delivery_match_eta_width_final = true -%}{%- endif -%}
      {%- if s.special_delivery_max_width != blank -%}{%- assign special_delivery_max_width_final = s.special_delivery_max_width -%}{%- endif -%}
      
      {%- if s.special_delivery_override_global_text_styling == true or s.special_delivery_override_global_text_styling == 'true' -%}
        {%- assign special_delivery_use_theme_text_styling_final = false -%}
        {%- if s.special_delivery_text_color != blank -%}{%- assign special_delivery_text_color_final = s.special_delivery_text_color -%}{%- endif -%}
        {%- if s.special_delivery_font_size != blank -%}{%- assign special_delivery_font_size_final = s.special_delivery_font_size -%}{%- endif -%}
        {%- if s.special_delivery_font_weight != blank -%}{%- assign special_delivery_font_weight_final = s.special_delivery_font_weight -%}{%- endif -%}
      {%- endif -%}
      {%- if s.special_delivery_text_alignment != blank -%}{%- assign special_delivery_text_alignment_final = s.special_delivery_text_alignment -%}{%- endif -%}
      {% break %}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}

{%- assign special_delivery_svg_resolved = '' -%}
{%- assign special_delivery_url_resolved = '' -%}
{%- assign special_delivery_is_preset = false -%}
{%- if special_delivery_icon_final != blank -%}
  {%- if special_delivery_icon_final contains 'custom-' -%}
    
    {%- assign custom_idx_str = special_delivery_icon_final | remove: 'custom-' -%}
    {%- assign custom_idx = custom_idx_str | minus: 1 -%}
    {%- if global_settings != nil and global_settings.custom_icons != blank and global_settings.custom_icons.size > custom_idx -%}
      {%- assign custom_icon = global_settings.custom_icons[custom_idx] -%}
      {%- if custom_icon.svg != blank -%}
        {%- assign special_delivery_svg_resolved = custom_icon.svg -%}
      {%- elsif custom_icon.url != blank -%}
        {%- assign special_delivery_url_resolved = custom_icon.url -%}
      {%- endif -%}
    {%- endif -%}
  {%- else -%}
    
    {%- assign special_delivery_is_preset = true -%}
  {%- endif -%}
{%- endif -%}

{%- assign icon_px = special_delivery_icon_size_final | default: 24 -%}

{%- assign icon_align_css = 'flex-start' -%}
{%- case special_delivery_icon_alignment_final -%}
  {%- when 'center' -%}{%- assign icon_align_css = 'center' -%}
  {%- when 'bottom' -%}{%- assign icon_align_css = 'flex-end' -%}
{%- endcase -%}

{%- assign final_icon_color = icon_color -%}
{%- if special_delivery_use_main_icon_color_final == false -%}
  {%- assign final_icon_color = special_delivery_icon_color_final -%}
{%- endif -%}

{%- assign final_font_family = '' -%}
{%- if special_delivery_use_theme_font_final == false -%}
  {%- if special_delivery_match_messages_font_final and messages_custom_font_family != blank -%}
    {%- assign final_font_family = messages_custom_font_family -%}
  {%- elsif special_delivery_custom_font_family_final != blank -%}
    {%- assign final_font_family = special_delivery_custom_font_family_final -%}
  {%- endif -%}
{%- endif -%}

{%- assign message_with_lb = special_delivery_message_final | replace: '{lb}', '<br>' -%}
{%- capture message_html -%}
  {%- if message_with_lb contains '**' -%}
    {%- assign parts = message_with_lb | split: '**' -%}
    {%- for part in parts -%}
      {%- assign mod = forloop.index | modulo: 2 -%}
      {%- if mod == 0 -%}<strong>{{ part }}</strong>{%- else -%}{{ part }}{%- endif -%}
    {%- endfor -%}
  {%- else -%}
    {{ message_with_lb }}
  {%- endif -%}
{%- endcapture -%}
{%- assign should_show_block = false -%}
{%- if any_rule_matched and show_special_delivery_final and special_delivery_message_final != blank -%}
  {%- assign should_show_block = true -%}
{%- endif -%}
{%- if request.design_mode -%}
{{ 'dib-messages.css' | asset_url | stylesheet_tag }}
<div style="text-align:{{ special_delivery_alignment }};{% if special_delivery_margin_top != 0 %}margin-top:{{ special_delivery_margin_top }}px;{% endif %}{% if special_delivery_margin_bottom != 0 %}margin-bottom:{{ special_delivery_margin_bottom }}px;{% endif %}"><div style="border:2px dashed #d1d5db;border-radius:8px;padding:16px 20px;background:#f9fafb;display:inline-flex;align-items:center;gap:12px;max-width:400px;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg><div><div style="font-weight:600;color:#374151;font-size:14px;margin-bottom:2px;">Special Delivery</div><div style="color:#6b7280;font-size:12px;">Configure rules in the app with "Show Special Delivery" enabled to display special delivery messaging here.</div></div></div></div>
{%- elsif should_show_block -%}
{{ 'dib-messages.css' | asset_url | stylesheet_tag }}
<style>
#{{ uid }} .dib-special-text{
  {%- if special_delivery_use_theme_text_styling_final == false -%}
    {%- if special_delivery_text_color_final != blank %}color:{{ special_delivery_text_color_final }};{%- endif %}
    {%- assign sd_font_size_num = special_delivery_font_size_final | plus: 0 -%}
    {%- if sd_font_size_num > 0 -%}font-size:{{ special_delivery_font_size_final }}px;
    {%- else -%}
      {%- case special_delivery_font_size_final -%}
        {%- when 'xsmall' %}font-size:12px;
        {%- when 'small' %}font-size:14px;
        {%- when 'large' %}font-size:18px;
        {%- when 'xlarge' %}font-size:20px;
        {%- else %}font-size:16px;
      {%- endcase %}
    {%- endif -%}
    {%- case special_delivery_font_weight_final -%}
      {%- when 'medium' %}font-weight:500;
      {%- when 'semibold' %}font-weight:600;
      {%- when 'bold' %}font-weight:700;
      {%- else %}font-weight:400;
    {%- endcase %}
  {%- endif -%}
}
{%- if final_font_family != blank %}
#{{ uid }} .dib-special-text{font-family:{{ final_font_family }}}
{%- endif %}
</style>
<div id="{{ uid }}" class="dib-special-delivery-block" {% if special_delivery_match_eta_width_final %}data-match-eta-width="true"{% endif %} style="text-align:{{ special_delivery_alignment }};{% if special_delivery_margin_top != 0 %}margin-top:{{ special_delivery_margin_top }}px;{% endif %}{% if special_delivery_margin_bottom != 0 %}margin-bottom:{{ special_delivery_margin_bottom }}px;{% endif %}">
  <div class="dib-special-delivery dib-container" style="display:inline-flex;align-items:{{ icon_align_css }};gap:{{ special_delivery_icon_gap }}px;box-sizing:border-box;overflow-wrap:break-word;word-break:break-word;text-align:{{ special_delivery_text_alignment_final }};padding:{{ special_delivery_padding_vertical }}px {{ special_delivery_padding_horizontal }}px;{%- if special_delivery_show_border_final -%}border:{{ special_delivery_border_thickness_final }}px solid {{ special_delivery_border_color_final }};border-radius:{{ special_delivery_border_radius_final }}px;{%- endif -%}{%- if special_delivery_max_width_final > 0 and special_delivery_match_eta_width_final == false -%}width:min({{ special_delivery_max_width_final }}px,100%);{%- endif -%}">
    {%- if special_delivery_is_preset -%}
      <div class="dib-special-icon" style="width:{{ icon_px }}px;height:{{ icon_px }}px;flex-shrink:0;color:{{ final_icon_color }};">{% render 'icon', icon: special_delivery_icon_final, style: special_delivery_icon_style_final %}</div>
    {%- elsif special_delivery_svg_resolved != blank -%}
      <div class="dib-special-icon" style="width:{{ icon_px }}px;height:{{ icon_px }}px;flex-shrink:0;color:{{ final_icon_color }};">{{ special_delivery_svg_resolved }}</div>
    {%- elsif special_delivery_url_resolved != blank -%}
      <img src="{{ special_delivery_url_resolved }}" alt="" class="dib-special-icon" style="width:{{ icon_px }}px;height:{{ icon_px }}px;flex-shrink:0;object-fit:contain;" loading="lazy">
    {%- endif -%}
    <div class="dib-special-text" style="min-width:0;">{{ message_html }}</div>
  </div>
</div>
{%- endif -%}
{% schema %}
{"name":"Special Delivery","target":"section","settings":[]}
{% endschema %}

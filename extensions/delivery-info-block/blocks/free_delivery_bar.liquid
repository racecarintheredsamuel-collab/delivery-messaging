{%- assign global_settings_json = shop.metafields.delivery_rules.settings.value -%}
{%- assign global_settings = nil -%}
{%- if global_settings_json != blank -%}
  {%- assign global_settings = global_settings_json | parse_json -%}
{%- endif -%}

{%- comment -%} Cart/General Free Delivery Messaging defaults {%- endcomment -%}
{%- assign fd_enabled = false -%}
{%- assign fd_threshold = 5000 -%}
{%- capture fd_message_progress -%}Spend {remaining} more for free delivery{%- endcapture -%}
{%- capture fd_message_unlocked -%}You've unlocked free delivery!{%- endcapture -%}
{%- assign fd_message_empty = '' -%}
{%- assign fd_message_excluded = '' -%}
{%- assign fd_show_progress_bar = true -%}
{%- assign fd_progress_bar_color = '#22c55e' -%}
{%- assign fd_progress_bar_bg = '#e5e7eb' -%}
{%- assign fd_bar_bg_color = '#f9fafb' -%}
{%- assign fd_exclude_tags = '' -%}
{%- assign fd_exclude_handles = '' -%}

{%- if global_settings != nil -%}
  {%- if global_settings.fd_enabled == true -%}
    {%- assign fd_enabled = true -%}
  {%- endif -%}
  {%- if global_settings.fd_threshold != blank -%}
    {%- assign fd_threshold = global_settings.fd_threshold -%}
  {%- endif -%}
  {%- if global_settings.fd_message_progress != blank -%}
    {%- assign fd_message_progress = global_settings.fd_message_progress -%}
  {%- endif -%}
  {%- if global_settings.fd_message_unlocked != blank -%}
    {%- assign fd_message_unlocked = global_settings.fd_message_unlocked -%}
  {%- endif -%}
  {%- if global_settings.fd_message_empty != blank -%}
    {%- assign fd_message_empty = global_settings.fd_message_empty -%}
  {%- endif -%}
  {%- if global_settings.fd_message_excluded != blank -%}
    {%- assign fd_message_excluded = global_settings.fd_message_excluded -%}
  {%- endif -%}
  {%- if global_settings.fd_show_progress_bar == false -%}
    {%- assign fd_show_progress_bar = false -%}
  {%- endif -%}
  {%- if global_settings.fd_progress_bar_color != blank -%}
    {%- assign fd_progress_bar_color = global_settings.fd_progress_bar_color -%}
  {%- endif -%}
  {%- if global_settings.fd_progress_bar_bg != blank -%}
    {%- assign fd_progress_bar_bg = global_settings.fd_progress_bar_bg -%}
  {%- endif -%}
  {%- if global_settings.fd_bar_bg_color != blank -%}
    {%- assign fd_bar_bg_color = global_settings.fd_bar_bg_color -%}
  {%- endif -%}
  {%- if global_settings.fd_exclude_tags != blank -%}
    {%- assign fd_exclude_tags = global_settings.fd_exclude_tags | json -%}
  {%- endif -%}
  {%- if global_settings.fd_exclude_handles != blank -%}
    {%- assign fd_exclude_handles = global_settings.fd_exclude_handles | json -%}
  {%- endif -%}
{%- endif -%}

{%- comment -%} Default excluded message {%- endcomment -%}
{%- if fd_message_excluded == blank -%}
  {%- assign fd_message_excluded = "Some items in your cart aren't eligible for free delivery" -%}
{%- endif -%}

{%- comment -%} Output config and scripts if cart messaging is enabled {%- endcomment -%}
{%- if fd_enabled -%}

{%- comment -%} Config for cart drawer messaging {%- endcomment -%}
<div id="dib-fd-config" style="display:none"
  data-dm-config
  data-threshold="{{ fd_threshold }}"
  data-currency="{{ shop.currency }}"
  data-locale="{{ request.locale.iso_code | default: 'en-GB' }}"
  data-message-progress="{{ fd_message_progress | escape }}"
  data-message-unlocked="{{ fd_message_unlocked | escape }}"
  data-message-empty="{{ fd_message_empty | escape }}"
  data-message-excluded="{{ fd_message_excluded | escape }}"
  data-exclude-tags="{{ fd_exclude_tags | escape }}"
  data-exclude-handles="{{ fd_exclude_handles | escape }}"
  data-show-progress-bar="{{ fd_show_progress_bar }}"
  data-progress-bar-color="{{ fd_progress_bar_color }}"
  data-progress-bar-bg="{{ fd_progress_bar_bg }}"
  data-bar-bg-color="{{ fd_bar_bg_color }}"
></div>

<style>
.dib-fd-bar.dib-fd-celebrate {
  animation: dib-fd-pulse 0.4s ease-out;
}
@keyframes dib-fd-pulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.02); opacity: 0.9; }
}
</style>

{%- comment -%} Scripts for cart drawer injection {%- endcomment -%}
<script src="{{ 'dib-free-delivery.js' | asset_url }}" defer></script>
<script src="{{ 'delivery-messaging.js' | asset_url }}" defer></script>

{%- endif -%}
{% schema %}
{"name":"Cart Messaging","target":"body","settings":[]}
{% endschema %}
